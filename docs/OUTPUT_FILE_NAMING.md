# Output File Naming Convention

## Overview

The snapshot CSV output files are automatically named based on the SQL query file name, making it easy to identify which query generated each snapshot.

## Naming Format

```
{query_file_name}_{timestamp}.csv
```

Where:
- `{query_file_name}` = SQL query file name without extension
- `{timestamp}` = Date and time in format `YYYY-MM-DD_HHMMSS`

## Examples

### Example 1: Query File = `queries.sql`

**Configuration:**
```env
SQL_QUERY_FILE=./config/queries.sql
```

**Output Files:**
```
output/snapshots/
├── queries_2025-12-25_080005.csv
├── queries_2025-12-25_120003.csv
└── queries_2025-12-25_180002.csv
```

### Example 2: Query File = `schedule_db_query.sql`

**Configuration:**
```env
SQL_QUERY_FILE=./config/schedule_db_query.sql
```

**Output Files:**
```
output/snapshots/
├── schedule_db_query_2025-12-25_080005.csv
├── schedule_db_query_2025-12-25_120003.csv
└── schedule_db_query_2025-12-25_180002.csv
```

### Example 3: Query File = `member_detailed_report.sql`

**Configuration:**
```env
SQL_QUERY_FILE=./config/member_detailed_report.sql
```

**Output Files:**
```
output/snapshots/
├── member_detailed_report_2025-12-25_080005.csv
├── member_detailed_report_2025-12-25_120003.csv
└── member_detailed_report_2025-12-25_180002.csv
```

### Example 4: Multiple Query Files

When using different query files for different purposes:

**Development:**
```env
SQL_QUERY_FILE=./config/queries_dev.sql
```
**Output:** `queries_dev_2025-12-25_080005.csv`

**Production:**
```env
SQL_QUERY_FILE=./config/queries_prod.sql
```
**Output:** `queries_prod_2025-12-25_080005.csv`

## Benefits

### 1. Self-Documenting
The file name immediately tells you which query generated it:
```
schedule_db_query_2025-12-25_080005.csv
└── Generated by: schedule_db_query.sql
```

### 2. Easy Organization
Different queries create distinct file sets:
```
output/snapshots/
├── member_summary_2025-12-25_080005.csv      # From member_summary.sql
├── member_summary_2025-12-25_120003.csv
├── member_detailed_2025-12-25_080010.csv     # From member_detailed.sql
└── member_detailed_2025-12-25_120008.csv
```

### 3. Simplified Cleanup
File retention automatically groups by query file:
```bash
# All files from schedule_db_query.sql older than 30 days
schedule_db_query_*.csv
```

### 4. Clear Audit Trail
Easy to track which query produced which output:
```bash
# Find all outputs from a specific query
ls output/snapshots/schedule_db_query_*.csv

# Count executions per query
ls output/snapshots/*.csv | cut -d'_' -f1-3 | sort | uniq -c
```

## File Name Components

### Query File Name Extraction

The query file name is extracted without the extension:

| Query File Path | Extracted Prefix |
|----------------|------------------|
| `./config/queries.sql` | `queries` |
| `./config/schedule_db_query.sql` | `schedule_db_query` |
| `./queries/member_report.sql` | `member_report` |
| `/app/config/custom_query.sql` | `custom_query` |

### Timestamp Format

Format: `YYYY-MM-DD_HHMMSS`

Examples:
- `2025-12-25_080005` = December 25, 2025 at 08:00:05
- `2025-12-25_120330` = December 25, 2025 at 12:03:30
- `2025-12-25_180145` = December 25, 2025 at 18:01:45

## File Management

### Listing Files

```bash
# All snapshot files
ls output/snapshots/

# Files from specific query
ls output/snapshots/schedule_db_query_*.csv

# Latest file from specific query
ls -t output/snapshots/schedule_db_query_*.csv | head -1

# Files from today
ls output/snapshots/*_2025-12-25_*.csv
```

### Counting Files

```bash
# Total files
ls -1 output/snapshots/*.csv | wc -l

# Files per query
for prefix in $(ls output/snapshots/*.csv | cut -d'_' -f1 | sort -u); do
    count=$(ls ${prefix}_*.csv 2>/dev/null | wc -l)
    echo "$prefix: $count files"
done
```

### Finding Files

```bash
# Files from specific date
find output/snapshots -name "*_2025-12-25_*.csv"

# Files from specific hour
find output/snapshots -name "*_2025-12-25_08*.csv"

# Files older than 30 days
find output/snapshots -name "*.csv" -mtime +30
```

## Docker Usage

### View Output Files

```bash
# List all snapshot files
docker exec schedule-db-query ls -lh /app/output/snapshots/

# List files from specific query
docker exec schedule-db-query ls -lh /app/output/snapshots/schedule_db_query_*.csv

# Copy latest file to host
docker cp schedule-db-query:/app/output/snapshots/$(docker exec schedule-db-query ls -t /app/output/snapshots/ | head -1) ./
```

### Volume Mounting

Ensure output directory is mounted:

**docker-compose.yml:**
```yaml
services:
  schedule-db-query:
    volumes:
      - ./output:/app/output    # Output files persist on host
```

## Automatic Cleanup

Files are automatically cleaned up based on `FILE_RETENTION_DAYS`:

```env
FILE_RETENTION_DAYS=30    # Keep files for 30 days
```

**How it works:**
1. After each snapshot execution, cleanup runs automatically
2. Files older than retention period are deleted
3. Only files matching the current query file prefix are checked
4. Other query file outputs are not affected

**Example:**
```
# Current query: schedule_db_query.sql
# Cleanup will only check: schedule_db_query_*.csv
# Will NOT delete: member_detailed_*.csv, queries_*.csv, etc.
```

## Migration from Old Naming

If you were using the generic `FILE_PREFIX` setting before:

### Old Behavior (Before)
```env
FILE_PREFIX=member_snapshot
SQL_QUERY_FILE=./config/schedule_db_query.sql
```
**Output:** `member_snapshot_2025-12-25_080005.csv`

### New Behavior (Now)
```env
# FILE_PREFIX is now ignored for naming (still in settings for backward compatibility)
SQL_QUERY_FILE=./config/schedule_db_query.sql
```
**Output:** `schedule_db_query_2025-12-25_080005.csv`

### Migration Steps

No action needed! The change is automatic:
1. Old files with old prefix remain untouched
2. New files use query file name prefix
3. Old files can be manually cleaned up if desired

## Best Practices

### 1. Descriptive Query File Names

Use clear, descriptive names for query files:

✅ **Good:**
- `member_snapshot.sql`
- `schedule_db_query.sql`
- `member_detailed_report.sql`
- `daily_sales_summary.sql`

❌ **Avoid:**
- `query.sql` (too generic)
- `q1.sql` (not descriptive)
- `test.sql` (unclear purpose)

### 2. Consistent Naming Convention

Use a consistent pattern across query files:

```
config/
├── member_snapshot.sql              # Member snapshots
├── transaction_summary.sql          # Transaction summaries
├── revenue_report.sql               # Revenue reports
└── audit_trail.sql                  # Audit trails
```

### 3. Environment Prefixes

Include environment in query file name if needed:

```
config/
├── prod_member_snapshot.sql
├── uat_member_snapshot.sql
└── dev_member_snapshot.sql
```

### 4. Date Organization

Output files are automatically timestamped, no need to add dates to query file names:

✅ **Good:** `member_snapshot.sql` → `member_snapshot_2025-12-25_080005.csv`

❌ **Avoid:** `member_snapshot_2025.sql` → `member_snapshot_2025_2025-12-25_080005.csv`

## Troubleshooting

### Issue: Output File Name Doesn't Match Query File

**Problem:**
```
Query: schedule_db_query.sql
Output: member_snapshot_2025-12-25_080005.csv  ❌
```

**Cause:** Using old version before this feature was implemented

**Solution:** Rebuild container with latest code:
```bash
docker-compose down
docker-compose build --no-cache
docker-compose up -d
```

### Issue: Special Characters in File Name

**Problem:**
```
Query: member-report!@#.sql
Output: member-report!@#_2025-12-25_080005.csv
```

**Solution:** Use only alphanumeric characters and underscores in query file names:
```
✅ member_report.sql
✅ schedule_db_query.sql
❌ member-report!@#.sql
```

### Issue: File Prefix Setting Ignored

**Problem:** `FILE_PREFIX` in `.env` doesn't affect output file names

**Expected Behavior:** This is correct! The file prefix is now automatically determined from the query file name. The `FILE_PREFIX` setting is kept for backward compatibility but not used for file naming.

**If you need custom prefix:** Rename your query file instead:
```bash
mv config/queries.sql config/custom_prefix.sql
```

Update `.env`:
```env
SQL_QUERY_FILE=./config/custom_prefix.sql
```

## Related Configuration

- `SQL_QUERY_FILE`: Query file path (determines output file prefix)
- `OUTPUT_DIR`: Where output files are saved (default: `./output/snapshots`)
- `FILE_RETENTION_DAYS`: How long to keep files (default: 30 days)
- `CSV_ENCODING`: Character encoding for CSV files (default: `utf-8`)

## See Also

- [SQL_QUERY_FILE_CONFIGURATION.md](./SQL_QUERY_FILE_CONFIGURATION.md) - Query file configuration
- [README.md](../README.md) - Main documentation
